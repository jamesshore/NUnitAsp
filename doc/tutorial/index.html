<html>
  <head>
    <title>NUnitAsp - ASP.NET unit testing: Tutorial</title>
		<link rel="stylesheet" type="text/css" href="../style.css">
  </head>
  <body>
		<p class="title">NUnitAsp
		<br /><small>ASP.NET unit testing</small></p>

		<table class="layout">
			<tr>
				<td>
					<div class="menu">
						<p><a href="../download.html"><b>Download</b></a></p>
						<p>
							<a href="../index.html">Overview</a>
							<br /><a href="../documentation.html">Documentation</a>
							<br /><a href="../support.html">Support</a>
							<br /><a href="../consulting.html">Training and Consulting</a>
						</p>
						<p><a href="../contribute.html">Contribute</p>
						<p><A href="http://sourceforge.net/projects/nunitasp/"><IMG src=
						"http://sourceforge.net/sflogo.php?group_id=49940" width="88" height="31" border="0" alt="SourceForge Logo"></A></p>
					</div>
				</td>
				<td>
					<div class="content">
						<h1>Test-Driven Development with NUnitAsp
						<br /><small>The NUnitAsp Tutorial</small></h1>

						<p>NUnitAsp is based on the principle that testing web pages should use the same concepts as creating them. When you use NUnitAsp, you use classes and IDs similar to those you used when creating the web page you are testing.</p>

						<p>In this tutorial, we'll walk you through the process of creating a simple one-page web application and tests. We assume you have some experience with ASP.NET and that you're using Visual Studio .NET (VS.NET) and Internet Information Server (IIS). The source for the "Guestbook" solution we create in this tutorial is located in the \sample directory of the NUnitAsp download. You can use the source as reference, but the tutorial doesn't discuss how to configure the files in the \sample directory to run. Instead, it assumes you will create your own solution and projects as you work through the tutorial.</p>

						<p>Advanced users may get started more quickly by jumping straight to the <a href="../quickstart.html">QuickStart Guide</a>.</p>


						<h2>About the Sample Application</h2>

						<p>The application we'll be creating in this tutorial is a simple on-line guest book.  It allows users to enter a name and comment, which is then displayed on the page.</p>

						<div class="figure">
							<img src="sample-app.gif" alt="Figure" />
							<br />Functionally complete application
						</div>


						<h2>Create a Test Project</h2>

						<div class="figure" style="float:right">
							<img src="create-project.gif" alt="Figure" />
							<br />Create a project
						</div>

						<p>Start by creating a class library project to contain your tests. We created a Visual Studio .NET solution named "GuestBook" and a C# class library project named "GuestBookTests."  Create a text fixture class that describes what you're testing.  We used "GuestBookTest."  Finally, add references to the NUnitAsp and NUnit frameworks.  NUnitAsp.dll is in the \bin directory of the NUnitAsp download and nunit.framework.dll is in the \bin directory of your NUnit install. The NUnitASP framework appears in the VS.NET References tree as "NUnitASP." The NUnit framework appears as "nunit.framework."</p>

						<p>Once your project and text fixture class have been created, modify your class to extend WebFormTestCase.  WebFormTestCase provides a "Browser" property for loading web pages.  It also provides some handy extra assertions.</p>

						<p>To simplify the code, you'll need to include two common NUnitAsp namespaces, NUnit.Extensions.Asp and NUnit.Extensions.Asp.AspTester, with "using" lines.</p>

						<p>We're almost ready to try it out.  The last thing we need is a test.  The simplest possible test is an empty test, so add a public method that starts with the word "Test" and has no body. We named our empty test "TestNothing."</p>

						<div class="code">
							<span class="keyword">using</span> System;
							<br /><span class="keyword">using</span> NUnit.Extensions.Asp;
							<br /><span class="keyword">using</span> NUnit.Extensions.Asp.AspTester;
							<br />
							<br /><span class="keyword">namespace</span> GuestBookTests
							<br />{
							<br />&nbsp;&nbsp;&nbsp;<span class="keyword">public class</span> GuestBookTest :
							WebFormTestCase
							<br />&nbsp;&nbsp;&nbsp;{
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="blue">public void</font> TestNothing()
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
							<br />&nbsp;&nbsp;&nbsp;}
							<br />}
						</div>

						<p>Compile the project. Now you have a working test!  Admittedly, it doesn't do much.  We'll expand it later.  For now, let's run it to make sure everything is set up properly.</p>

						<h2>Running the First Test</h2>

						<p>An easy way to run the tests is to start the nunit-gui.exe application and keep it open while debugging, using Alt-Tab to switch between nunit-gui.exe and VS.NET.

						<p>The nunit-gui.exe application monitors the currently loaded test assembly and reloads it automatically when it changes. This means you can keep an instance of nunit-gui.exe open and then run tests simply by clicking "Run," regardless of how you have changed your test assembly.</p>

						<p>To use this method, start nunit-gui.exe separately from VS.NET. You can find nunit-gui.exe in the \bin directory of your NUnit install. Then, in nunit-gui.exe, open your test assembly using the "Open..." menu item (or drag the test assembly into the nunit-gui.exe window). Now you can make changes to your test assembly in VS.NET, use Alt-Tab to switch to nunit-gui.exe, and click "Run" to run the updated tests.</p>

						<p>Now click the "Run" button in nunit-gui.exe.  You'll see this screen:</p>

						<div class="figure">
							<img src="run-nunit.gif" alt="Run the tests" />
						</div>

						<h2>Create a Real Test</h2>

						<p>Now we're ready to start testing our application. That's right, we're going to write our tests <i>first</i>.  It's a style of programming called "Test-Driven Development," and it's part of the Extreme Programming methodology that programs like NUnit were created to support.  In test-driven development, you create tests for features that you want, then write production code to make the tests pass.  By doing so, you increase test coverage and reduce the amount of unnecessary production code.

						<p>In our case, the feature we want is a guest book.  Testing every aspect of a guest book would take far too long, but we can test to see if the web page even exists.  That's a broad test, but we can refine from there.  We don't want to take too long between running tests&mdash;the goal is to check our code frequently so we always know we're on the right track.

						<p>First we'll modify our empty test to load the Web page we're going to write.  WebFormTestCase, our parent class, provides a "Browser" property for getting web pages. Call "Browser.GetPage(<i>web page url</i>)" to load the page.  We also changed the name of the test to something a little more meaningful.</p>

						<div class="code">
							<span class="keyword">public void</span> TestLayout()
							<br>{
							<br>&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br>}
						</div>

						<div class="figure" style="float:right">
							<img src="create-webproject.gif" alt="Figure"/>
							<br />Create a web project
						</div>

						<p>Now compile the test (Ctrl+Shift+B), switch to nunit-gui.exe, and run the test. It will fail, because the page doesn't exist yet, but we want to run it anyway. The reason is so that we find out immediately if things aren't working the way we expect. The sooner we know about problems, the easier it is to fix them. When testing with NUnitAsp (and NUnit), get into the habit of writing a small test, watching it fail, writing a few lines of code, watching the test pass, then refactoring. You should repeat this cycle every few minutes. If you do, you'll never get into a situation where you spend a lot of time debugging, and your code quality will remain high.</p>

						<p>The test fails, as expected, so now we want to make it pass. Create a web project and the corresponding page. In our case, we created "GuestBook" as our web project and "GuestBook.aspx" as our web page. This page is at <a href="http://localhost/GuestBook/Guestbook.aspx">http://localhost/GuestBook/Guestbook.aspx</a> if you've set up a virtual directory for it.</p>

						<p>Now, when you run the test, it passes.

						<p>(If you receive a 401 Access Denied error, check your security settings. For example, try enabling anonymous access for the GuestBook virtual directory, and make sure the IUSR_<i>machinename</i> user has read access to the directory.)</p>



						<h2>Test the Layout</h2>

						<p>The next thing we'll test is the layout of our page.  We don't test the look of our web page&mdash;we don't want to have to update our tests every time someone changes a font&mdash;but we do test the functionality.  The first step towards doing this is just making sure the right components are on the page.</p>

						<p>First, create a rough sketch showing the page to be created.  No need to be fancy: this is just something for us to refer back to as we work, not formal documentation.  In our guest book application, we want four components: a text field for entering a name (called "name"), a text field for entering a comment (called "comments"), a button to save the data in the guest book (called "save"), and a datagrid for displaying what people have entered (called "book").</p>

						<div class="figure">
							<img src="screen-sketch.gif" alt="Hand-drawn sketch of screen layout"/>
						</div>

						<p>To test these components, we have to create NUnitAsp "tester" objects.  A tester is an object that corresponds to an ASP.NET control you want to test.  You can instantiate the tester at any time&mdash;even before the page is loaded, if you like.  When you instantiate it, you tell the tester the name of the ASP.NET control it's supposed to test and which control it's located on.  Since we're going to test four controls on our guest book, we need to create four tester objects.</p>

						<div class="code">
							<span class="demph">public void TestLayout()
							<br />{</span>
							<br /><span class="emph">&nbsp;&nbsp;&nbsp;TextBoxTester name = <span class="keyword">new</span> TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = <span class="keyword">new</span> TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = <span class="keyword">new</span> ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = <span class="keyword">new</span> DataGridTester("book", CurrentWebForm);</span>
							<br />
							<span class="demph"><br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br>}</span>
						</div>

						<p>Let's take a closer look at the first declaration:</p>

						<p>
							<table>
								<tr>
									<th>Code Fragment</th>
									<th>Meaning</th>
								</tr>
								<tr>
									<td><code><b>TextBoxTester name = <span class="keyword">new</span> TextBoxTester</b><span class="demph">("name", CurrentWebForm);</span></code></td><td>The object named "name" will test a text box.</td>
								</tr>
								<tr>
									<td><code><span class="demph">TextBoxTester name = new TextBoxTester(</span><b>"name"</b><span class="demph">, CurrentWebForm);</span></code></td>
									<td>The ASP.NET ID  of the text box is "name."</td>
								</tr>
								<tr>
									<td><code><span class="demph">TextBoxTester name = new TextBoxTester("name", </span><b>CurrentWebForm</b><span class="demph">);</span></code></td>
									<td>Look for the control on the web form currently loaded by the browser.</td>
								</tr>
							</table>
						</p>

						<p>Now that we have the testers, we can assert that their controls are visible on the page.</p>

						<div class="code">
							<span class="demph">public void TestLayout()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");</span>
							<br />
							<br /><span class="emph">&nbsp;&nbsp;&nbsp;AssertVisibility(name, <span class="keyword">true</span>);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(comments, <span class="keyword">true</span>);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(save, <span class="keyword">true</span>);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(book, <span class="keyword">true</span>);</span>
							<span class="demph"><br>}</span>
						</div>

						<p>We've just told NUnitAsp to assert that the four controls are visible on the page. Again, looking at the first line of code:</p>

						<p>
							<table>
								<tr>
									<th>Code Fragment</th>
									<th>Meaning</th>
								</tr>
								<tr>
									<td><code><b>AssertVisibility</b><span class="demph">(name, true);</span></code></td>
									<td>Call the method in WebFormTestCase that checks control visibility.</td>
								</tr>
								<tr>
									<td><code><span class="demph">AssertVisibility(</span><b>name</b></span><span class="demph">, true);</span></code></td>
									<td>Check the visibility using the "name" tester.  The tester knows its control is a TextBox whose ID is "name."</td>
								</tr>
								<tr>
									<td><code><span class="demph">AssertVisibility(name, <b></span><span class="keyword">true</span>);</span></code></td>
									<td>The control should be visible.</td>
								</tr>
							</table>
						</p>

						<p>We're ready to run the test.  We expect it to fail: we asserted that several controls were visible, but they're not.  When we run the test, it does:</p>

						<blockquote>
							<code class="error">TestLayout: name control should be visible (HTML ID: name; ASP location: TextBoxTester 'name' in web form 'GuestBook')</code>
						</blockquote>

						<p>This error message is in two parts.  The first part tells us what failed (the 'name' control wasn't visible, as we expected).  The second part, in parentheses, helps us track down the exact control that failed.</p>

						<p>NUnitAsp always tells you the name of the control in two ways.  First, it gives you the HTML ID of the control.  This ID corresponds to the ID the control has when you use "View Source" in your browser.  It's handy when you're looking at HTML: you can usually just do a "find" and type in the HTML ID to find your HTML-ized control.  If it's visible, that is!</p>

						<p>The second way NUnitAsp tells you about the control is with the ASP.NET location.  It tells you the location of the control that failed, the control that it's in, the control that <i>that</i> control is in, etc., up to the name of the web form.  This information is handy when you're looking at ASP.NET code.</p>

						<p>In this simple example, all that information seems redundant.  However, in ASP.NET, controls can be nested within other controls.  The ID you give a control in ASP.NET can change into a completely different ID in HTML.  The information in the error message helps you track down all the information you need to solve problems.</p>

						<p>Let's make the tests pass by adding the four controls.  We won't worry about looks just yet.</p>

						<div class="html">
							&lt;form id=&quot;GuestBook&quot; method=&quot;post&quot; runat=&quot;server&quot;&gt;
							<br />&nbsp;&nbsp;&nbsp;&lt;asp:TextBox ID=&quot;name&quot; Runat=&quot;server&quot;&gt;&lt;/asp:TextBox&gt;
							<br />&nbsp;&nbsp;&nbsp;&lt;asp:TextBox ID=&quot;comments&quot; Runat=&quot;server&quot;&gt;&lt;/asp:TextBox&gt;
							<br />&nbsp;&nbsp;&nbsp;&lt;asp:Button ID=&quot;save&quot; RunAt=&quot;server&quot; Text=&quot;Save&quot;&gt;&lt;/asp:Button&gt;
							<br />&nbsp;&nbsp;&nbsp;&lt;asp:DataGrid ID=&quot;book&quot; RunAt=&quot;server&quot;&gt;&lt;/asp:DataGrid&gt;
							<br />&lt;/form&gt;
						</div>

						<p>Now run the test again.  It still didn't pass!  The data grid wasn't visible.  This is a perfect example of why we run the tests so often.  Sometimes we get surprised.</p>

						<p>The data grid probably didn't show up because we haven't put any data in it yet.  Well, after thinking about it, that's actually the behavior we want... when there's no data, don't display any results.  Let's update the test to reflect this.</p>

						<div class="code">
							<span class="demph">public void TestLayout()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(name, true);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(comments, true);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(save, true);</span>
							<br /><span class="emph">&nbsp;&nbsp;&nbsp;AssertVisibility(book, <span class="keyword">false</span>);</span>
							<span class="demph"><br>}</span>
						</div>
						<p>Now the tests pass.</p>

						<h2>Test a Little Bit of Behavior</h2>

						<p>We have a web page, but it doesn't do anything yet.  The next thing we want to see is that entering something updates the guest book.  Naturally, we start by writing a test.</p>

						<div class="code">
							<span class="demph">public void TestLayout()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br />
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(name, true);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(comments, true);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(save, true);
							<br />&nbsp;&nbsp;&nbsp;AssertVisibility(book, false);
							<br />}
							<br /></span>
							<br /><span class="emph">public void TestSave()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br />
							<br />&nbsp;&nbsp;&nbsp;name.Text = &quot;Dr. Seuss&quot;;
							<br />&nbsp;&nbsp;&nbsp;comments.Text = &quot;One Guest, Two Guest!  Guest Book, Best Book!&quot;;
							<br />&nbsp;&nbsp;&nbsp;save.Click();
							<br />}</span>
						</div>

						<p>We've created a new test named "TestSave."  It's has the same tester set up and page load that the "TestLayout" method does, but then it does something different: it assigns values to the web page and presses the "Save" button.</p>

						<p>
							<table>
								<tr>
									<th>Code Fragment</th>
									<th>Meaning</th>
								</tr>
								<tr>
									<td><code>name.Text = &quot;Dr. Seuss&quot;;</code></td><td>Set the text of the "name" text box to "Dr. Seuss".</td>
								</tr>
								<tr>
									<td><code>comments.Text = &quot;One Guest, Two Guest!  Guest Book, Best Book!&quot;;</td><td>Set the text of the "comments" text box.</td>
								</tr>
								<tr>
									<td><code>save.Click();</code></td>
									<td>Click the "Save" button.</td>
								</tr>
							</table>
						</p>

						<p>Stop and take another look at the code.  This is the heart of what NUnitAsp is all about.  Although the test isn't actually working with an ASP.NET page&mdash;the page is raw HTML, like any rendered ASP.NET page&mdash;you can manipulate the controls on it with simple ASP.NET-like properties and methods. Pretty cool, and very easy. To write a test like this without NUnitASP, you would have to know how ASP.NET renders each control to HTML, and then you'd have to manage that complexity every time you examined or set a control on the page. NUnitASP abstracts this complexity away from you, enabling you to use ASP.NET-like syntax rather than worrying about how each control appears in rendered HTML.</p>

						<p>Run the test.  It passes, unsurprisingly.  We're filling in the text and clicking "Save," but we're not actually asserting anything.  Let's fix that.  We'll start by asserting that the name and comment fields are reset to be blank after you save.</p>

						<div class="code">
							<span class="demph">public void TestSave()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br />
							<br />&nbsp;&nbsp;&nbsp;name.Text = &quot;Dr. Seuss&quot;;
							<br />&nbsp;&nbsp;&nbsp;comments.Text = &quot;One Guest, Two Guest!  Guest Book, Best Book!&quot;;
							<br />&nbsp;&nbsp;&nbsp;save.Click();</span>
							<br />
							<span class="emph"><br />&nbsp;&nbsp;&nbsp;AssertEquals("name", "", name.Text);
							<br />&nbsp;&nbsp;&nbsp;AssertEquals("comments", "", comments.Text);</span>
							<span class="demph"><br />}</span>
						</div>

						<p>The AssertEquals method is just a standard NUnit assertion, but here's the breakdown in case you're not familiar with it:</p>

						<p>
						<table>
								<tr>
									<th>Code Fragment</th>
									<th>Meaning</th>
								</tr>
								<tr>
									<td><code><span class="emph">AssertEquals</span><span class="demph">(&quot;name&quot;, &quot;&quot;, name.Text);</span></code></td><td>Assert that two objects are equal.</td>
								</tr>
								<tr>
									<td><code><span class="demph">AssertEquals(</span><span class="emph">&quot;name&quot;</span><span class="demph">, &quot;&quot;, name.Text);</span></code></td><td>The text to use in the failure message.</td>
								</tr>
								<tr>
									<td><code><span class="demph">AssertEquals(&quot;name&quot;, </span><span class="emph">&quot;&quot;</span><span class="demph">, name.Text);</span></code></td><td>The expected results (an empty string).</td>
								</tr>
								<tr>
									<td><code><span class="demph">AssertEquals(&quot;name&quot;, &quot;&quot;, </span><span class="emph">name.Text</span><span class="demph">);</span></code></td><td>The actual results (the text in the "name" text box).</td>
								</tr>
						</table>
						</p>

						<p>When you run the test, it fails!</p>

						<blockquote>
							<code class="error">TestSave : name
							String lengths differ. Expected length=0, but was length=9.
							Strings differ at index 0.

							expected: &lt;&gt;
							but was: &lt;Dr. Seuss&gt;
							---------^
							</code>
						</blockquote>

						<p>Were you surprised?  I was.  I had forgotten that the default behavior in ASP.NET is to preserve the values of its controls.  For now, let's fix the problem by adding some code to the web page's code-behind to always initialize the text boxes to be blank. (If you wonder about this code, you're on to something. Keep reading.)</p>

						<div class="code">
							<span class="keyword">private void </span>Page_Load(<span class="keyword">object</span> sender, System.EventArgs e)
							<br />{
							<br />&nbsp;&nbsp;&nbsp;name.Text = "";
							<br />&nbsp;&nbsp;&nbsp;comments.Text = "";
							<br />}
						</div>

						<p>Run the tests and see that they pass now.</p>

						<p>Notice how similar the code-behind is to the tests?  That's intentional.  NUnitAsp will generally have the same methods on its testers that are on real ASP.NET objects.</p>

						<p>Now for the meat of the test.  We want to assert that the "book" data grid is populated with the user's name and comments.  Since checking the contents of a data grid is a common need, NUnitASP includes functionality to make this easy.</p>

						<p>NUnitAsp allows you to treat a data grid as an array of cells.  More accurately, it enables you to treat a data grid as an array of string arrays.  The string arrays in the outer array correspond to the rows of the data grid, and the strings in the inner arrays correspond to the cells of the data grid.  This is best illustrated by an example.  A string array that looks like this:</p>

						<div class="code">
							<span class="keyword">string</span>[][] expected = <span class="keyword">new string</span>[][]
							<br />{
							<br />&nbsp;&nbsp;&nbsp;<span class="keyword">new string</span>[] {"Dr. Seuss", "One Guest, Two Guest!  Guest Book, Best Book!"},
							<br />&nbsp;&nbsp;&nbsp;<span class="keyword">new string</span>[] {"Dr. Freud", "Nice slip you have there."}
							<br />};
						</div>

						<p>Corresponds to a data grid table that looks like this:</p>

						<p>
							<table>
								<tr>
									<td>Dr. Seuss</td>
									<td>One Guest, Two Guest!  Guest Book, Best Book!</td>
								</tr>
								<tr>
									<td>Dr. Freud</td>
									<td>Nice slip you have there.</td>
								</tr>
							</table>
						</p>

						<p>Unsurprisingly, DataGridTester has a method that returns the data grid's contents in an array in exactly this format.  WebFormTestCase also provides several assertion methods that allow you to assert things about the contents of this kind of array.  We'll use this functionality to assert that the guest book contains Dr. Seuss's comments after he presses the "Save" button. Note that we're only testing a single entry here, which means we only have one row, so our assertion array only has one outer element.</p>

						<div class="code">
							<span class="demph">public void TestSave()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester name = new TextBoxTester("name", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;TextBoxTester comments = new TextBoxTester("comments", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;ButtonTester save = new ButtonTester("save", CurrentWebForm);
							<br />&nbsp;&nbsp;&nbsp;DataGridTester book = new DataGridTester("book", CurrentWebForm);
							<br />
							<br />&nbsp;&nbsp;&nbsp;Browser.GetPage("http://localhost/GuestBook/GuestBook.aspx");
							<br />&nbsp;&nbsp;&nbsp;name.Text = &quot;Dr. Seuss&quot;;
							<br />&nbsp;&nbsp;&nbsp;comments.Text = &quot;One Guest, Two Guest!  Guest Book, Best Book!&quot;;
							<br />&nbsp;&nbsp;&nbsp;save.Click();
							<br />
							<br />&nbsp;&nbsp;&nbsp;AssertEquals("name", "", name.Text);
							<br />&nbsp;&nbsp;&nbsp;AssertEquals("comments", "", comments.Text);</span>
							<br />
							<br />&nbsp;&nbsp;&nbsp;<span class="emph"><span class="keyword">string</span>[][] expected = <span class="keyword">new string</span>[][]
							<br />&nbsp;&nbsp;&nbsp;{
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new string</span>[] {"Dr. Seuss", "One Guest, Two Guest!  Guest Book, Best Book!"}
							<br />&nbsp;&nbsp;&nbsp;};
							<br />&nbsp;&nbsp;&nbsp;AssertEquals("book", expected, book.TrimmedCells);</span>
							<span class="demph"><br />}</span>
						</div>

						<p>If you run the tests now, you see that the save test fails because NUnitASP can't find a control named "book".</p>

						<p>Remember when we changed the TestLayout test to succeed when the "book" element wasn't visible, because it didn't yet hold any data? TestSave is failing right now for a similar reason, except that we now want the grid to be visible, and to contain the information we've entered in the text boxes. Since we haven't added any functionality to the page to update the data grid when we click "Save," the data grid is still not visible.</p>

						<h2>Implement a Little Bit of Behavior</h2>

						<p>To fix this problem, let's add functionality to the page that updates the data grid with the information we enter when we click "Save." We already have the test that will show when we've implemented it correctly - now it's just a matter of writing the code that makes the test pass.</p>

						<p>First, double-click the "Save" button, which cause VS.NET to create and register an empty save_Click method for the "Save" button's Click event.</p>

						<p>The DataGrid control needs a data source from which to retrieve the data it displays. In this sample application, we'll implement this using a DataTable instance with two columns, one each for the name and comments fields. The DataGrid persists its internal state - what it's displaying - in the view state that is transmitted back and forth with each request and response. However, it does not store the actual data source that supplied this data. Since we want to add to the data grid, we need to store the data source ourselves. To add a new row to the data grid, we add a row to the data source and then rebind the data source to the data grid. In this sample, we'll store the DataTable instance in the user's session. In a real-life application, you would most likely retrieve the data from a database.</p>

						<p>Our specific implementation of the save_Click method retrieves the current data source. If the data source is null, we know this is the first time the guest book has been manipulated, so we create a new, empty, data source, using our own GetEmptyGuestBook method, and store a reference to this data source in the user's session. Once we have a valid DataTable instance to represent our data source, the code simply creates a new row (a DataRow instance), sets the fields in the row to the current values of the name and comment textboxes, and then adds the new row to the data source. Finally, now that we have a data source that contains the newly-entered name and comment information, we bind the data source to the data grid.</p>

						<p>Note that you can't just paste the following code into VS.NET and have it work correctly, because this code relies on the save_Click method being connected to the "Save" button's Click event. The easiest way to accomplish this is to double-click the "Save" button, which automatically creates the correct hookup code and gives you an empty save_Click method into which you can paste the code.</p>

						<div class="code">
							private void save_Click(object sender, System.EventArgs e)
							<br />{
							<br />&nbsp;&nbsp;&nbsp;DataTable currGuestBook = (DataTable) Session["GuestBook"];
							<br />
							<br />&nbsp;&nbsp;&nbsp;if (currGuestBook == null) {
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currGuestBook = GetEmptyGuestBook();
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Session["GuestBook"] = currGuestBook;
							<br />&nbsp;&nbsp;&nbsp;}
							<br />
							<br />&nbsp;&nbsp;&nbsp;DataRow newRow = currGuestBook.NewRow();
							<br />&nbsp;&nbsp;&nbsp;newRow["Name"] = name.Text;
							<br />&nbsp;&nbsp;&nbsp;newRow["Comments"] = comments.Text;
							<br />&nbsp;&nbsp;&nbsp;currGuestBook.Rows.Add(newRow);
							<br />
							<br />&nbsp;&nbsp;&nbsp;book.DataSource = currGuestBook;
							<br />&nbsp;&nbsp;&nbsp;book.DataBind();
							<br />}
							<br />
							<br />private DataTable GetEmptyGuestBook()
							<br />{
							<br />&nbsp;&nbsp;&nbsp;DataTable newGuestBook = new DataTable();
							<br />
							<br />&nbsp;&nbsp;&nbsp;newGuestBook.Columns.Add(new DataColumn("Name", typeof(string)));
							<br />&nbsp;&nbsp;&nbsp;newGuestBook.Columns.Add(new DataColumn("Comments", typeof(string)));
							<br />
							<br />&nbsp;&nbsp;&nbsp;return newGuestBook;
							<br />}
						</div>

						<p>Compile the code-behind assembly and run the tests. The save behavior test fails, but with a new error.</p>

						<p>Our new code now shows a grid, but the grid doesn't contain what we expect. Instead of the "Dr. Seuss" name and comment string, the nunit-gui.exe application tells us that the row in the data grid contains empty strings. If you load the page in a browser, you see as much: you get a new row in the data grid when you click "Save," but it doesn't contain the name and comment information you entered.</p>

						<p>If you think about the order in which the Page class events are fired, you can see what's going on. The Load event (to which the Page_Load method is connected) fires before any postback events, like the Save event fired by the button control. The Page_Load method contains code that sets the Text properties of the text boxes to empty strings. This means when the save_Click method executes, the Text properties it uses no longer contain the information the user entered. Instead, they contain the empty strings set by the Page_Load method. These empty strings are what's being added to the data grid.</p>

						<p>We actually don't need to clear the fields when we load the page - after all, the Page_Load method fires each time the page is displayed, including the first time when no data could be present. Instead, let's clear the fields in save_Click, after we've stored the data they contain. This makes sense - the only time we need to clear values is after the user has entered data and the data has been saved. To fix the problem, we remove the two lines of code from the Page_Load method and place them at the bottom of the save_Click method.</p>

						<div class="code">
							<span class="emph">
							// note that Page_Load is now empty
							<br />private void Page_Load(object sender, System.EventArgs e)
							<br />{
							<br />}</span>
							<br />
							<br />private void save_Click(object sender, System.EventArgs e)
							<br />{
							<br />&nbsp;&nbsp;&nbsp;DataTable currGuestBook = (DataTable) Session["GuestBook"];
							<br />
							<br />&nbsp;&nbsp;&nbsp;if (currGuestBook == null) {
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currGuestBook = GetEmptyGuestBook();
							<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Session["GuestBook"] = currGuestBook;
							<br />&nbsp;&nbsp;&nbsp;}
							<br />
							<br />&nbsp;&nbsp;&nbsp;DataRow newRow = currGuestBook.NewRow();
							<br />&nbsp;&nbsp;&nbsp;newRow["Name"] = name.Text;
							<br />&nbsp;&nbsp;&nbsp;newRow["Comments"] = comments.Text;
							<br />&nbsp;&nbsp;&nbsp;currGuestBook.Rows.Add(newRow);
							<br />
							<br />&nbsp;&nbsp;&nbsp;book.DataSource = currGuestBook;
							<br />&nbsp;&nbsp;&nbsp;book.DataBind();
							<br />
							<span class="emph">
							<br />&nbsp;&nbsp;&nbsp;// the information has been saved, so clear the text boxes
							<br />&nbsp;&nbsp;&nbsp;name.Text = "";
							<br />&nbsp;&nbsp;&nbsp;comments.Text = "";</span>
							<br />}
</div>

						<p>Run the tests again. This time both of them pass.</p>


						<p class="end">The remainder of the tutorial is unfinished.</p>

						<h2>Test Boundary Conditions</h2>


						<h2>Test Performance</h2>


						<h2>Make it Pretty</h2>


						<h2>Conclusion</h2>

						<p>As you start writing your own tests with NUnitAsp, try following the pattern used in this tutorial.  To write this tutorial, I simply wrote down what I did while creating the sample application.  Other than the limited scope of the application, nothing about this tutorial is simplified.  Experienced test-driven development programmers really do run tests every couple of minutes, even when they know the results.  Once you get used to it, it evolves into a predictable rhythm:</p>

						<blockquote>
							Write test...
							<br />...watch test fail.
							<br />Write code...
							<br />...watch test pass.
							<br />Write test...
							<br />...watch test fail.
							<br />Write code...
							<br />...watch test pass.
							<br />Write test...
							<br />...watch test fail.
							<br />Write code...
							<br />...watch test pass.
						</blockquote>

						<p>Every so often, the rhythm will be broken.  A test will fail when it shouldn't, or fail for the wrong reason, or even pass when it shouldn't.  If you've been running tests every few minutes, then the defect is in the last few minutes' work... it only takes a few seconds to figure out your mistake.  If you haven't been running tests often, though, you'll have to spend a lot more time debugging.

						<p>These are the steps I really do follow when creating new web pages:</p>

						<ul>
							<li>Create a test class.</li>
							<li>Create an empty test.
							<br /><i>(Watch test pass)</i></li>
							<li>Modify the test to navigate to the web page.
							<br /><i>(Watch test fail)</i></li>
							<li>Create the web page.
							<br /><i>(Watch test pass)</i></li>
							<li>Test the layout.
							<br /><i>(Watch test fail)</i></li>
							<li>Add controls to the web page.
							<br /><i>(Watch test pass)</i></li>
							<li>Repeat the following until all desired behavior is present:
								<ul>
									<li>Test a small amount of behavior
									<br /><i>(Watch test fail)</i></li>
									<li>Implement a small amount of behavior
									<br /><i>(Watch test pass)</i></li>
								</ul>
							</li>
							<li>Repeat the following until all boundary conditions are handled:
								<ul>
									<li>Test a single boundary condition
									<br /><i>(Watch test fail)</i></li>
									<li>Fix a single boundary condition
									<br /><i>(Watch test pass)</i></li>
								</ul>
							<li>Optional: Test and optimize performance.</li>
							<li>Make it pretty.</li>
						</ul>

						<p>Test-driven development is a relaxing, low-risk approach to software development.  Once you get used to it, it's fast and reliable.  Follow the pattern above, and you'll spend more time adding features and less time fixing defects.</p>

						<p class="end">
							by Jim Little and Andrew Enfield
							<br />Last updated for v1.3.
						</p>
					</div>
				</td>
			</tr>
		</table>
  </body>
</html>